# **Map**: построение карты транспортной системы

Карта должна выводиться в ответ на запрос Map в секции **stat_requests**

```json
  {
    "id": 999,
    "type": "Map"
  }
```

Ответ на запрос Map содержит единственный ключ "map" с SVG-документом:

```json
{
  "map": "<?xml version=\"1.0\" encoding=\"UTF-8\" ?><svg xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\"></svg>"
}
```

Карта состоит из объектов следующих типов:
1. Линии (ломаные) автобусных маршрутов
1. Круги, обозначающие остановки
1. Названия остановок
1. Названия автобусов

## Алгоритмы отрисовки

### Проекция координат на карту

Суть алгоритма — использование долгот и широт в качестве координат x и y и их масштабирование для вписания в прямоугольник (**width** - 2 * **padding**) × (**height** - 2 * **padding**).

Для начала, вычисляются минимальные и максимальные значения широт и долгот: min_lat, min_lon, max_lat, max_lon. Дальнейшие преобразования приведут к тому, что остановка с минимальной долготой (**longitude**) будет иметь минимальную координату **x** — равную **padding**; остановка с максимальной широтой (самая северная) будет иметь минимальную координату **y**, тоже равную **padding**.

Максимально допустимый коэффициент масштабирования долгот в иксы **width_zoom_coef** = (width - 2 * padding) / (max_lon - min_lon). Аналогично, максимально допустимый коэффициент масштабирования широт в игреки **height_zoom_coef** = (height - 2 * padding) / (max_lat - min_lat).

Итоговый коэффициент масштабирования (единый для обеих осей) **zoom_coef** выберем как минимум из width_zoom_coef и height_zoom_coef. Если при вычислении одного из упомянутых выше коэффициентов возникло деление на 0 (из-за того, что все остановки имеют одинаковую широту или одинаковую долготу), в качестве zoom_coef необходимо выбрать другой из двух коэффициентов. Если же все остановки имеют одинаковые координаты, будем считать zoom_coef = 0.

Наконец, получаем следующие формулы вычисления x и y по долготе (lon) и широте (lat):
```
x = (lon - min_lon) * zoom_coef + padding;
y = (max_lat - lat) * zoom_coef + padding;
```

### Определение цветов автобусов

Значение настройки **color_palette** — это цветовая палитра, из которой выбираются цвета для автобусных линий. Первый по алфавиту автобус должен получить первый цвет, второй автобус — второй цвет и т. д. Если автобусов оказывается больше, чем цветов палитре, цвета переиспользуются по циклу: например, в случае 10 автобусов и 3 цветов в палитре первый цвет получат 1-й, 4-й, 7-й и 10-й автобусы.

### Отрисовка автобусных маршрутов

Линии автобусных маршрутов выводятся в порядке возрастания номера (названия) автобуса.

Каждая линия — это ломаная со следующими свойствами:
* Цвет линии (**stroke**) определён в соответствии с описанными выше правилами;
* Толщина линии (**stroke-width**) равна настройке line_width;
* Формы конца линии (**stroke-linecap**) и соединений (**stroke-linejoin**) равны "round".

Вершины каждой ломаной — это координаты соответствующих остановок. Вершины выводятся в порядке обхода маршрута от первой до первой остановки по кольцевому маршруту: количество вершин должно оказаться равным значению величины stop_count из ответа на запрос Bus. Таким образом, в случае некольцевого маршрута ("is_roundtrip": false) каждый отрезок между соседними остановками будет нарисован дважды.

### Отрисовка кругов остановок

Круги остановок выводятся в порядке возрастания названия остановки, по одному на каждую остановку, независимо от количества автобусов, проходящих через конкретную остановку.

Круг имеет следующие свойства:

* Координаты центра (**cx** и **cy**) — координаты соответствующей остановки;
* Радиус (**r**) равен настройке **stop_radius**;
* Цвет заливки (**fill**) — "white".

### Отрисовка названий остановок

Названия остановок выводятся в порядке возрастания названия, по одному на каждую остановку.

Для каждой остановки необходимо выводятся два текстовых объекта: полупрозрачная подложка и сама надпись.

Общие свойства обоих объектов:
* Координаты (**x** и **y**) — координаты соответствующей остановки;
* Смещение (**dx** и **dy**) равно настройке **stop_label_offset**;
* Размер шрифта (**font-size**) равно настройке **stop_label_font_size**;
* Название шрифта (**font-family**) — "Verdana";
* Содержимое — собственно название остановки.

Дополнительные свойства подложки:
* Цвет заливки (**fill**) и цвет линий (**stroke**) равны настройке **underlayer_color**.
* Толщина линий (**stroke-width**) равна настройке **underlayer_width**.
* Формы конца линии (**stroke-linecap**) и соединений (**stroke-linejoin**) равны "round".

Дополнительное свойство самой надписи:
* Цвет заливки (**fill**) — "black".

### Отрисовка названий автобусов

Названия автобусов отрисовываются у конечных остановок. В случае кольцевого маршрута ("is_roundtrip": true) конечной считается первая остановка маршрута, в случае некольцевого — первая и последняя.

Названия автобусов выводятся в порядке возрастания названий, а в рамках одного автобуса — сначала для первой конечной, а затем, если маршрут некольцевой и конечные не совпадают, для второй.

Для каждого названия у конечной выводятся два текстовых объекта: полупрозрачная подложка и сама надпись.

Общие свойства обоих объектов:
* Координаты (**x** и **y**) — координаты соответствующей остановки.
* Смещение (**dx** и **dy**) равно настройке **bus_label_offset**.
* Размер шрифта (**font-size**) равно настройке **bus_label_font_size**.
* Название шрифта (**font-family**) — "Verdana".
* Насыщенность шрифта (**font-weight**) — "bold". (Для остальных SVG-объектов font-weight должен отсутствовать в списке свойств.)
* Содержимое — собственно название автобуса.

Дополнительные свойства подложки:
* Цвет заливки (**fill**) и цвет линий (**stroke**) равны настройке **underlayer_color**.
* Толщина линий (**stroke-width**) равна настройке **underlayer_width**.
* Формы конца линии (**stroke-linecap**) и соединений (**stroke-linejoin**) равны "round".

Дополнительное свойство самой надписи:
* Цвет заливки (**fill**) равен цвету соответствующего автобуса из палитры.
